<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faster 99 - Facility Management Tool</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="login-box">
            <div class="login-header">
                <h1>âš¡ Faster <span>99</span></h1>
                <p>Facility Management System</p>
            </div>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" placeholder="your.email@faster99.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="login-role">
                        <option value="admin">Administrator</option>
                        <option value="manager">Facility Manager</option>
                        <option value="technician">Maintenance Tech</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                <button type="submit" class="login-btn">ğŸ” Sign In</button>
            </form>
            <p class="demo-hint">Demo: Enter any email/password to login</p>
        </div>
    </div>

    <div id="sidebar">
        <!-- Header -->
        <div class="header">
            <h1 class="logo">âš¡ Faster <span>99</span></h1>
            <p class="tagline">Facility Management Hub</p>
            <div id="user-info" class="user-info hidden">
                <span id="user-name">Guest</span>
                <button onclick="handleLogout()" class="logout-btn">Logout</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="facilities">ğŸ“ Facilities</button>
            <button class="nav-tab" data-tab="resources">ğŸ“š Resources</button>
            <button class="nav-tab" data-tab="dashboard">ğŸ“Š Dashboard</button>
            <button class="nav-tab" data-tab="tickets">ğŸ« Tickets</button>
            <button class="nav-tab" data-tab="data">ğŸ“¤ Data</button>
        </div>

        <!-- Tab: Facilities -->
        <div id="tab-facilities" class="tab-content active">
            <!-- Search & Filter -->
            <div class="search-section">
                <input type="text" id="search-input" placeholder="ğŸ” Search facilities...">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-type="all">All</button>
                    <button class="filter-btn" data-type="distribution">Distribution</button>
                    <button class="filter-btn" data-type="hub">Hub</button>
                    <button class="filter-btn" data-type="warehouse">Warehouse</button>
                    <button class="filter-btn" data-type="fulfillment">Fulfillment</button>
                    <button class="filter-btn" data-type="sorting">Sorting</button>
                    <button class="filter-btn" data-type="crossdock">Cross-Dock</button>
                    <button class="filter-btn" data-type="cold_storage">Cold Storage</button>
                    <button class="filter-btn" data-type="returns">Returns</button>
                </div>
            </div>

            <!-- Facility List -->
            <div id="facility-list">
                <p class="loading">Loading facilities...</p>
            </div>

            <!-- Facility Details Panel (hidden by default) -->
            <div id="facility-details" class="hidden">
                <button class="back-btn" onclick="showFacilityList()">â† Back to List</button>
                <div id="details-content"></div>
            </div>
        </div>

        <!-- Tab: Resources (REM, IT, Security, Risk) -->
        <div id="tab-resources" class="tab-content">
            <h2 class="tab-title">ğŸ“š Resource Center</h2>
            <p class="tab-description">Quick access to key department resources and support channels.</p>
            
            <div class="resource-card rem">
                <div class="resource-icon">ğŸ¢</div>
                <div class="resource-content">
                    <h3>REM - Real Estate Management</h3>
                    <p>Property leasing, space planning, and facility expansion requests.</p>
                    <ul class="resource-links">
                        <li><a href="#">ğŸ“‹ Space Request Form</a></li>
                        <li><a href="#">ğŸ“Š Lease Management Portal</a></li>
                        <li><a href="#">ğŸ“ Contact: rem@faster99.com</a></li>
                    </ul>
                </div>
            </div>

            <div class="resource-card it">
                <div class="resource-icon">ğŸ’»</div>
                <div class="resource-content">
                    <h3>IT Support</h3>
                    <p>Technical support, network issues, and system access requests.</p>
                    <ul class="resource-links">
                        <li><a href="#">ğŸ« Submit IT Ticket</a></li>
                        <li><a href="#">ğŸ“– Knowledge Base</a></li>
                        <li><a href="#">ğŸ“ Help Desk: 1-800-555-TECH</a></li>
                    </ul>
                </div>
            </div>

            <div class="resource-card security">
                <div class="resource-icon">ğŸ”’</div>
                <div class="resource-content">
                    <h3>Security</h3>
                    <p>Access control, surveillance, and emergency response coordination.</p>
                    <ul class="resource-links">
                        <li><a href="#">ğŸ”‘ Access Request Form</a></li>
                        <li><a href="#">ğŸ“¹ Surveillance Request</a></li>
                        <li><a href="#">ğŸš¨ Emergency: 1-800-555-SAFE</a></li>
                    </ul>
                </div>
            </div>

            <div class="resource-card risk">
                <div class="resource-icon">âš ï¸</div>
                <div class="resource-content">
                    <h3>Risk Management</h3>
                    <p>Insurance claims, compliance, and incident reporting.</p>
                    <ul class="resource-links">
                        <li><a href="#">ğŸ“ Incident Report Form</a></li>
                        <li><a href="#">ğŸ“‹ Insurance Claims Portal</a></li>
                        <li><a href="#">ğŸ“ Contact: risk@faster99.com</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Tab: Dashboard -->
        <div id="tab-dashboard" class="tab-content">
            <h2 class="tab-title">ğŸ“Š Facilities Dashboard</h2>
            <p class="tab-description">Overview of all facility metrics and statistics.</p>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <span class="stat-number" id="stat-total">-</span>
                    <span class="stat-label">Total Facilities</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-sqft">-</span>
                    <span class="stat-label">Total Sq. Ft.</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-employees">-</span>
                    <span class="stat-label">Total Employees</span>
                </div>
            </div>

            <div class="dashboard-section">
                <h3>ğŸ“ˆ Facilities by Type</h3>
                <div id="type-chart" class="type-chart"></div>
            </div>

            <div class="dashboard-section">
                <h3>ğŸ† Largest Facilities</h3>
                <div id="top-facilities" class="top-facilities"></div>
            </div>

            <div class="dashboard-section">
                <h3>ğŸ“ Geographic Coverage</h3>
                <div class="coverage-info" id="coverage-info">
                    <p>Loading coverage data...</p>
                </div>
            </div>

            <div class="dashboard-section">
                <h3>ğŸ—ºï¸ Facilities by State</h3>
                <div id="state-chart" class="type-chart"></div>
            </div>
        </div>

        <!-- Tab: Data Import -->
        <div id="tab-data" class="tab-content">
            <h2 class="tab-title">ğŸ“¤ Data Import</h2>
            <p class="tab-description">Import facility data from CSV or Excel files.</p>
            
            <div class="upload-section">
                <h3>ğŸ“ Upload CSV File</h3>
                <p class="upload-hint">Upload a CSV file with facility data to add to the map.</p>
                
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">ğŸ“„</div>
                    <p>Drag & drop a CSV file here</p>
                    <p class="upload-or">or</p>
                    <label class="upload-btn">
                        Choose File
                        <input type="file" id="csv-file" accept=".csv" hidden>
                    </label>
                </div>
                
                <div id="upload-status" class="upload-status hidden"></div>
            </div>
            
            <div class="template-section">
                <h3>ğŸ“‹ CSV Template</h3>
                <p>Your CSV file should have these columns:</p>
                <div class="template-columns">
                    <span class="col required">id</span>
                    <span class="col required">name</span>
                    <span class="col required">type</span>
                    <span class="col required">address</span>
                    <span class="col required">latitude</span>
                    <span class="col required">longitude</span>
                    <span class="col">size_sqft</span>
                    <span class="col">employees</span>
                    <span class="col">manager_name</span>
                    <span class="col">manager_email</span>
                    <span class="col">manager_phone</span>
                </div>
                <button class="download-template-btn" onclick="downloadTemplate()">
                    â¬‡ï¸ Download Template
                </button>
            </div>
            
            <div class="import-history">
                <h3>ğŸ“Š Current Data</h3>
                <div id="data-summary">
                    <p>Loading data summary...</p>
                </div>
            </div>
            
            <div class="export-section">
                <h3>ğŸ“¥ Export Data</h3>
                <p>Download facility data as CSV files for Excel.</p>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportFacilities()">
                        ğŸ“Š Export All Facilities
                    </button>
                    <button class="export-btn secondary" onclick="exportContacts()">
                        ğŸ‘¥ Export All Contacts
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab: Tickets -->
        <div id="tab-tickets" class="tab-content">
            <h2 class="tab-title">ğŸ« Work Orders</h2>
            <p class="tab-description">Submit and track maintenance requests.</p>
            
            <div class="ticket-form-section">
                <h3>ğŸ“ Submit New Request</h3>
                <form id="ticket-form" onsubmit="submitTicket(event)">
                    <div class="form-group">
                        <label>Facility</label>
                        <select id="ticket-facility" required>
                            <option value="">Select a facility...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="ticket-category" required>
                            <option value="">Select category...</option>
                            <option value="hvac">HVAC Issue</option>
                            <option value="electrical">Electrical</option>
                            <option value="plumbing">Plumbing</option>
                            <option value="security">Security</option>
                            <option value="equipment">Equipment Malfunction</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="ticket-priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="ticket-title" placeholder="Brief description..." required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="ticket-description" placeholder="Detailed description of the issue..." rows="3"></textarea>
                    </div>
                    <button type="submit" class="submit-ticket-btn">ğŸ« Submit Request</button>
                </form>
            </div>
            
            <div class="ticket-list-section">
                <h3>ğŸ“‹ Recent Tickets</h3>
                <div class="ticket-filters">
                    <button class="ticket-filter active" data-status="all">All</button>
                    <button class="ticket-filter" data-status="open">Open</button>
                    <button class="ticket-filter" data-status="in_progress">In Progress</button>
                    <button class="ticket-filter" data-status="resolved">Resolved</button>
                </div>
                <div id="ticket-list">
                    <p class="no-tickets">No tickets yet. Submit your first request above!</p>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <!-- Address Search Control on Map -->
    <div id="geocoder-container" class="geocoder-container"></div>

    <script>
        // Configure Mapbox Token
        mapboxgl.accessToken = 'pk.eyJ1Ijoia2VsbHktMjM0IiwiYSI6ImNtbTJreTM2cTA4ZHUycXBydTRqaWp0eTkifQ.SVpQqcW7lvEdQ1zCXI-rvw';

        let facilitiesData = null;
        let currentFilter = 'all';
        let searchMarker = null;

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [-95.7, 37.0], // Center of US
            zoom: 4
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

        // Add Geocoder (Address Search) control
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'ğŸ” Search any address in the US...',
            countries: 'us',
            marker: false
        });

        document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));

        // Handle geocoder result
        geocoder.on('result', (e) => {
            // Remove existing search marker
            if (searchMarker) {
                searchMarker.remove();
            }
            
            // Add new marker
            searchMarker = new mapboxgl.Marker({ color: '#ff0000' })
                .setLngLat(e.result.center)
                .setPopup(new mapboxgl.Popup().setHTML(`
                    <strong>ğŸ“ Search Result</strong><br>
                    ${e.result.place_name}
                `))
                .addTo(map);
            
            searchMarker.togglePopup();
        });

        // Facility type colors
        const typeColors = {
            'distribution': '#e74c3c',
            'hub': '#3498db',
            'fulfillment': '#9b59b6',
            'sorting': '#e67e22',
            'warehouse': '#2ecc71',
            'crossdock': '#1abc9c',
            'service': '#f39c12',
            'returns': '#95a5a6',
            'cold_storage': '#00bcd4'
        };

        // Facility type labels
        const typeLabels = {
            'distribution': 'Distribution Center',
            'hub': 'Hub',
            'fulfillment': 'Fulfillment Center',
            'sorting': 'Sorting Facility',
            'warehouse': 'Warehouse',
            'crossdock': 'Cross-Dock',
            'service': 'Service Center',
            'returns': 'Returns Center',
            'cold_storage': 'Cold Storage'
        };

        // =============================================
        // USER AUTHENTICATION
        // =============================================
        
        let currentUser = null;
        
        // Check if user is logged in
        function checkAuth() {
            const savedUser = localStorage.getItem('fm_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            } else {
                showLoginModal();
            }
        }
        
        function showLoginModal() {
            document.getElementById('login-modal').classList.add('active');
        }
        
        function hideLoginModal() {
            document.getElementById('login-modal').classList.remove('active');
        }
        
        function showMainApp() {
            hideLoginModal();
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('user-name').textContent = currentUser.email.split('@')[0];
        }
        
        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const role = document.getElementById('login-role').value;
            
            // For demo purposes, accept any credentials
            currentUser = {
                email: email,
                role: role,
                loginTime: new Date().toISOString()
            };
            
            localStorage.setItem('fm_user', JSON.stringify(currentUser));
            showMainApp();
        }
        
        function handleLogout() {
            localStorage.removeItem('fm_user');
            currentUser = null;
            document.getElementById('user-info').classList.add('hidden');
            showLoginModal();
        }
        
        // Check auth on page load
        document.addEventListener('DOMContentLoaded', checkAuth);

        // API Configuration
        const API_URL = 'https://faster99-api-eafbb2bah6hnguc4.eastus2-01.azurewebsites.net';

        map.on('load', () => {
            // Load GeoJSON data from API
            fetch(API_URL + '/api/facilities')
                .then(response => response.json())
                .then(data => {
                    facilitiesData = data;
                    
                    map.addSource('facilities', {
                        type: 'geojson',
                        data: data
                    });

                    // Add circle layer for facility points
                    map.addLayer({
                        id: 'points',
                        type: 'circle',
                        source: 'facilities',
                        paint: {
                            'circle-radius': 10,
                            'circle-color': [
                                'match',
                                ['get', 'type'],
                                'distribution', typeColors.distribution,
                                'hub', typeColors.hub,
                                'fulfillment', typeColors.fulfillment,
                                'sorting', typeColors.sorting,
                                'warehouse', typeColors.warehouse,
                                'crossdock', typeColors.crossdock,
                                'service', typeColors.service,
                                'returns', typeColors.returns,
                                'cold_storage', typeColors.cold_storage,
                                '#999999'
                            ],
                            'circle-stroke-width': 3,
                            'circle-stroke-color': '#ffffff'
                        }
                    });

                    // Add labels
                    map.addLayer({
                        id: 'labels',
                        type: 'symbol',
                        source: 'facilities',
                        layout: {
                            'text-field': ['get', 'id'],
                            'text-size': 10,
                            'text-offset': [0, 1.5]
                        },
                        paint: {
                            'text-color': '#333'
                        }
                    });

                    // Render facility list
                    renderFacilityList(data.features);
                    
                    // Render dashboard
                    renderDashboard(data.features);
                    
                    // Update data summary
                    updateDataSummary();
                    
                    // Initialize ticket system
                    populateFacilityDropdown();
                    loadTickets();

                    // Click interaction - show facility details
                    map.on('click', 'points', (e) => {
                        const props = e.features[0].properties;
                        // Switch to facilities tab
                        switchTab('facilities');
                        showFacilityDetails(props);
                    });

                    // Change cursor style on hover
                    map.on('mouseenter', 'points', () => map.getCanvas().style.cursor = 'pointer');
                    map.on('mouseleave', 'points', () => map.getCanvas().style.cursor = '');
                });
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchTab(tab.dataset.tab);
            });
        });

        // =============================================
        // DATA IMPORT FUNCTIONS
        // =============================================
        
        // Update data summary on Data tab
        function updateDataSummary() {
            if (!facilitiesData) return;
            
            const features = facilitiesData.features || [];
            const byType = {};
            features.forEach(f => {
                const type = f.properties.type || 'unknown';
                byType[type] = (byType[type] || 0) + 1;
            });
            
            document.getElementById('data-summary').innerHTML = `
                <div class="data-stats">
                    <div class="data-stat">
                        <span class="data-stat-value">${features.length}</span>
                        <span class="data-stat-label">Total Facilities</span>
                    </div>
                    <div class="data-stat">
                        <span class="data-stat-value">${Object.keys(byType).length}</span>
                        <span class="data-stat-label">Facility Types</span>
                    </div>
                </div>
                <div class="type-breakdown">
                    ${Object.entries(byType).map(([type, count]) => `
                        <div class="type-row">
                            <span class="type-name">${typeLabels[type] || type}</span>
                            <span class="type-count">${count}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // Download CSV template
        function downloadTemplate() {
            const template = `id,name,type,address,latitude,longitude,size_sqft,employees,manager_name,manager_email,manager_phone
FAC-001,Main Warehouse,warehouse,123 Main St Chicago IL,41.8781,-87.6298,50000,120,John Smith,j.smith@company.com,312-555-1234
FAC-002,Distribution Center,distribution,456 Oak Ave Dallas TX,32.7767,-96.7970,75000,200,Mike Johnson,m.johnson@company.com,214-555-5678`;
            
            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'facility_template.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Export facilities to CSV
        function exportFacilities() {
            window.open(API_URL + '/api/export/csv', '_blank');
        }
        
        // Export contacts to CSV
        function exportContacts() {
            window.open(API_URL + '/api/export/contacts', '_blank');
        }
        
        // =============================================
        // TICKET SYSTEM FUNCTIONS
        // =============================================
        
        let allTickets = [];
        let currentTicketFilter = 'all';
        
        // Populate facility dropdown for tickets
        function populateFacilityDropdown() {
            if (!facilitiesData) return;
            
            const select = document.getElementById('ticket-facility');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select a facility...</option>';
            
            facilitiesData.features.forEach(f => {
                const option = document.createElement('option');
                option.value = f.properties.id;
                option.textContent = `${f.properties.id} - ${f.properties.name}`;
                select.appendChild(option);
            });
        }
        
        // Submit new ticket
        function submitTicket(event) {
            event.preventDefault();
            
            const ticket = {
                facility_id: document.getElementById('ticket-facility').value,
                category: document.getElementById('ticket-category').value,
                priority: document.getElementById('ticket-priority').value,
                title: document.getElementById('ticket-title').value,
                description: document.getElementById('ticket-description').value
            };
            
            fetch(API_URL + '/api/tickets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ticket)
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Ticket created: ' + result.ticket.id);
                    document.getElementById('ticket-form').reset();
                    loadTickets();
                }
            })
            .catch(error => alert('Failed to create ticket: ' + error.message));
        }
        
        // Load tickets from API
        function loadTickets() {
            fetch(API_URL + '/api/tickets')
                .then(response => response.json())
                .then(result => {
                    allTickets = result.tickets || [];
                    renderTickets();
                })
                .catch(error => console.error('Failed to load tickets:', error));
        }
        
        // Render ticket list
        function renderTickets() {
            const list = document.getElementById('ticket-list');
            if (!list) return;
            
            let filtered = allTickets;
            if (currentTicketFilter !== 'all') {
                filtered = allTickets.filter(t => t.status === currentTicketFilter);
            }
            
            if (filtered.length === 0) {
                list.innerHTML = '<p class="no-tickets">No tickets found.</p>';
                return;
            }
            
            list.innerHTML = filtered.map(t => `
                <div class="ticket-card ${t.priority}">
                    <div class="ticket-header">
                        <span class="ticket-id">${t.id}</span>
                        <span class="ticket-status ${t.status}">${t.status.replace('_', ' ')}</span>
                    </div>
                    <h4 class="ticket-title">${t.title}</h4>
                    <div class="ticket-meta">
                        <span>ğŸ“ ${t.facility_id}</span>
                        <span>ğŸ·ï¸ ${t.category}</span>
                        <span class="priority-badge ${t.priority}">${t.priority}</span>
                    </div>
                    <p class="ticket-desc">${t.description || 'No description'}</p>
                    <div class="ticket-actions">
                        ${t.status === 'open' ? `<button onclick="updateTicketStatus('${t.id}', 'in_progress')">Start Work</button>` : ''}
                        ${t.status === 'in_progress' ? `<button onclick="updateTicketStatus('${t.id}', 'resolved')">Mark Resolved</button>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // Update ticket status
        function updateTicketStatus(ticketId, newStatus) {
            fetch(API_URL + '/api/tickets/' + ticketId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    loadTickets();
                }
            })
            .catch(error => alert('Failed to update ticket: ' + error.message));
        }
        
        // Setup ticket filter listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.ticket-filter').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.ticket-filter').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTicketFilter = btn.dataset.status;
                    renderTickets();
                });
            });
        });
        
        // Handle file upload
        function handleFileUpload(file) {
            if (!file || !file.name.endsWith('.csv')) {
                showUploadStatus('Please upload a CSV file.', 'error');
                return;
            }
            
            showUploadStatus('Uploading and processing...', 'info');
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch(API_URL + '/api/upload/csv', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    showUploadStatus('Error: ' + result.error, 'error');
                } else {
                    showUploadStatus(`Success! Imported ${result.count} facilities.`, 'success');
                    // Optionally update the map with new data
                    console.log('Imported data:', result.data);
                }
            })
            .catch(error => {
                showUploadStatus('Upload failed: ' + error.message, 'error');
            });
        }
        
        function showUploadStatus(message, type) {
            const status = document.getElementById('upload-status');
            status.className = `upload-status ${type}`;
            status.textContent = message;
            status.classList.remove('hidden');
        }
        
        // Setup file upload listeners
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('csv-file');
            const uploadArea = document.getElementById('upload-area');
            
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        handleFileUpload(e.target.files[0]);
                    }
                });
            }
            
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files[0]) {
                        handleFileUpload(e.dataTransfer.files[0]);
                    }
                });
            }
        });

        // Render dashboard statistics
        function renderDashboard(features) {
            // Total stats
            const totalFacilities = features.length;
            const totalSqft = features.reduce((sum, f) => sum + f.properties.size_sqft, 0);
            const totalEmployees = features.reduce((sum, f) => sum + f.properties.employees, 0);

            document.getElementById('stat-total').textContent = totalFacilities;
            document.getElementById('stat-sqft').textContent = (totalSqft / 1000000).toFixed(2) + 'M';
            document.getElementById('stat-employees').textContent = totalEmployees.toLocaleString();

            // Facilities by type chart
            const typeCounts = {};
            features.forEach(f => {
                const type = f.properties.type;
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            const chartContainer = document.getElementById('type-chart');
            chartContainer.innerHTML = Object.entries(typeCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([type, count]) => {
                    const percentage = (count / totalFacilities * 100).toFixed(0);
                    const color = typeColors[type] || '#999';
                    return `
                        <div class="chart-bar">
                            <div class="chart-label">${typeLabels[type] || type}</div>
                            <div class="chart-bar-container">
                                <div class="chart-bar-fill" style="width: ${percentage}%; background: ${color}"></div>
                                <span class="chart-value">${count}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            // Top facilities by size
            const topFacilities = [...features]
                .sort((a, b) => b.properties.size_sqft - a.properties.size_sqft)
                .slice(0, 5);

            document.getElementById('top-facilities').innerHTML = topFacilities.map((f, i) => {
                const p = f.properties;
                const color = typeColors[p.type] || '#999';
                return `
                    <div class="top-facility-item" onclick="selectFacility('${p.id}'); switchTab('facilities');">
                        <span class="top-rank">#${i + 1}</span>
                        <div class="top-info">
                            <span class="top-name">${p.name}</span>
                            <span class="top-size">${p.size_sqft.toLocaleString()} sqft</span>
                        </div>
                        <span class="top-badge" style="background:${color}">${p.type}</span>
                    </div>
                `;
            }).join('');

            // Facilities by state
            const stateCounts = {};
            features.forEach(f => {
                const address = f.properties.address;
                const state = address.split(',').pop().trim();
                stateCounts[state] = (stateCounts[state] || 0) + 1;
            });

            const stateColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#95a5a6'];
            const stateChartContainer = document.getElementById('state-chart');
            stateChartContainer.innerHTML = Object.entries(stateCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([state, count], index) => {
                    const percentage = (count / totalFacilities * 100).toFixed(0);
                    const color = stateColors[index % stateColors.length];
                    return `
                        <div class="chart-bar">
                            <div class="chart-label">${state}</div>
                            <div class="chart-bar-container">
                                <div class="chart-bar-fill" style="width: ${percentage}%; background: ${color}"></div>
                                <span class="chart-value">${count}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            // Geographic coverage info
            const uniqueStates = Object.keys(stateCounts).length;
            document.getElementById('coverage-info').innerHTML = `
                <p><strong>${uniqueStates}</strong> states covered across the US</p>
                <p><strong>${totalFacilities}</strong> facilities nationwide</p>
                <p>Average <strong>${Math.round(totalEmployees / uniqueStates)}</strong> employees per state</p>
            `;
        }

        // Render facility list in sidebar
        function renderFacilityList(features) {
            const listContainer = document.getElementById('facility-list');
            
            const filteredFeatures = features.filter(f => {
                const matchesFilter = currentFilter === 'all' || f.properties.type === currentFilter;
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const matchesSearch = !searchTerm || 
                    f.properties.name.toLowerCase().includes(searchTerm) ||
                    f.properties.id.toLowerCase().includes(searchTerm) ||
                    f.properties.address.toLowerCase().includes(searchTerm);
                return matchesFilter && matchesSearch;
            });

            if (filteredFeatures.length === 0) {
                listContainer.innerHTML = '<p class="no-results">No facilities found</p>';
                return;
            }

            listContainer.innerHTML = filteredFeatures.map(f => {
                const p = f.properties;
                const color = typeColors[p.type] || '#999';
                return `
                    <div class="facility-card" onclick="selectFacility('${p.id}')">
                        <div class="facility-header">
                            <span class="facility-badge" style="background:${color}">${p.id}</span>
                            <span class="facility-type">${typeLabels[p.type] || p.type}</span>
                        </div>
                        <h3 class="facility-name">${p.name}</h3>
                        <p class="facility-address">${p.address}</p>
                        <div class="facility-stats">
                            <span>ğŸ“¦ ${p.size_sqft.toLocaleString()} sqft</span>
                            <span>ğŸ‘¥ ${p.employees} employees</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select facility from list
        function selectFacility(id) {
            const feature = facilitiesData.features.find(f => f.properties.id === id);
            if (feature) {
                // Fly to location
                map.flyTo({
                    center: feature.geometry.coordinates,
                    zoom: 12
                });
                // Show details
                showFacilityDetails(feature.properties);
            }
        }

        // Show facility details panel
        function showFacilityDetails(props) {
            // Parse JSON strings if needed
            const contacts = typeof props.contacts === 'string' ? JSON.parse(props.contacts) : props.contacts;
            const equipment = typeof props.equipment === 'string' ? JSON.parse(props.equipment) : props.equipment;
            const procedures = typeof props.emergency_procedures === 'string' ? JSON.parse(props.emergency_procedures) : props.emergency_procedures;
            
            const color = typeColors[props.type] || '#999';

            document.getElementById('facility-list').classList.add('hidden');
            document.getElementById('facility-details').classList.remove('hidden');
            
            document.getElementById('details-content').innerHTML = `
                <div class="detail-header" style="border-left: 4px solid ${color}">
                    <span class="detail-badge" style="background:${color}">${props.id}</span>
                    <h2>${props.name}</h2>
                    <p class="detail-type">${typeLabels[props.type] || props.type}</p>
                    <p class="detail-address">ğŸ“ ${props.address}</p>
                </div>

                <div class="detail-section">
                    <h3>ğŸ“Š Facility Info</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Size</span>
                            <span class="info-value">${props.size_sqft.toLocaleString()} sqft</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Employees</span>
                            <span class="info-value">${props.employees}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section collapsible">
                    <h3 class="section-toggle" onclick="toggleSection(this)">
                        <span>ğŸ‘¥ Key Contacts</span>
                        <span class="toggle-icon">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div class="contacts-grid">
                            ${renderContact('Facility Manager', contacts.facility_manager, 'ğŸ¢')}
                            ${renderContact('IT Support', contacts.it_support, 'ğŸ’»')}
                            ${renderContact('Maintenance', contacts.maintenance, 'ğŸ”§')}
                            ${renderContact('Security', contacts.security, 'ğŸ”’')}
                        </div>
                    </div>
                </div>

                <div class="detail-section collapsible">
                    <h3 class="section-toggle" onclick="toggleSection(this)">
                        <span>âš™ï¸ Equipment</span>
                        <span class="toggle-icon">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <ul class="equipment-list">
                            ${equipment.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <div class="detail-section collapsible">
                    <h3 class="section-toggle" onclick="toggleSection(this)">
                        <span>ğŸš¨ Emergency Procedures</span>
                        <span class="toggle-icon">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <p class="section-hint">Select an issue type to see troubleshooting steps:</p>
                        <div class="emergency-buttons">
                            ${Object.keys(procedures).map(key => `
                                <button class="emergency-btn" onclick="showProcedure('${key}', this)">
                                    ${getEmergencyIcon(key)} ${formatProcedureName(key)}
                                </button>
                            `).join('')}
                        </div>
                        <div id="procedure-steps" class="procedure-steps hidden"></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ğŸ—ºï¸ Floor Plan</h3>
                    <button class="floor-plan-btn" onclick="showFloorPlan('${props.id}')">
                        View Floor Plan
                    </button>
                </div>
            `;

            // Store procedures in window for access
            window.currentProcedures = procedures;
        }

        function renderContact(role, contact, icon) {
            return `
                <div class="contact-card">
                    <div class="contact-icon">${icon}</div>
                    <div class="contact-info">
                        <span class="contact-role">${role}</span>
                        <span class="contact-name">${contact.name}</span>
                        <a href="mailto:${contact.email}" class="contact-email">${contact.email}</a>
                        <a href="tel:${contact.phone}" class="contact-phone">${contact.phone}</a>
                    </div>
                </div>
            `;
        }

        function getEmergencyIcon(key) {
            const icons = {
                'power_outage': 'âš¡',
                'hvac_failure': 'â„ï¸',
                'security_breach': 'ğŸš¨',
                'water_leak': 'ğŸ’§',
                'fire_alarm': 'ğŸ”¥',
                'equipment_malfunction': 'âš™ï¸',
                'conveyor_jam': 'ğŸ”„',
                'dock_door_malfunction': 'ğŸšª',
                'weather_emergency': 'ğŸŒªï¸',
                'forklift_accident': 'ğŸšœ',
                'structural_issue': 'ğŸ—ï¸',
                'fuel_spill': 'â›½',
                'vehicle_fire': 'ğŸš’',
                'hazmat_package': 'â˜¢ï¸',
                'system_failure': 'ğŸ’»',
                'temperature_alarm': 'ğŸŒ¡ï¸',
                'refrigerant_leak': 'â„ï¸',
                'vehicle_accident': 'ğŸš—',
                'severe_weather': 'â›ˆï¸'
            };
            return icons[key] || 'âš ï¸';
        }

        function formatProcedureName(key) {
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function toggleSection(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.textContent = 'â–²';
                header.classList.add('expanded');
            } else {
                content.classList.add('collapsed');
                icon.textContent = 'â–¼';
                header.classList.remove('expanded');
            }
        }

        function showProcedure(key, btn) {
            const container = document.getElementById('procedure-steps');
            
            // If clicking the same active button, collapse it
            if (btn.classList.contains('active')) {
                btn.classList.remove('active');
                container.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            // Update button states
            document.querySelectorAll('.emergency-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const steps = window.currentProcedures[key];
            container.classList.remove('hidden');
            container.innerHTML = `
                <h4>${getEmergencyIcon(key)} ${formatProcedureName(key)}</h4>
                <ol class="steps-list">
                    ${steps.map(step => `<li>${step}</li>`).join('')}
                </ol>
            `;
        }

        function showFloorPlan(facilityId) {
            // Create modal for floor plan
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <button class="modal-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                    <h2>Floor Plan - ${facilityId}</h2>
                    <div class="floor-plan-container">
                        <div class="floor-plan-placeholder">
                            <p>ğŸ—ï¸ Floor Plan Preview</p>
                            <p class="placeholder-text">CAD/BIM integration would display the facility layout here.</p>
                            <div class="sample-floor-plan">
                                <div class="fp-zone fp-office">Office</div>
                                <div class="fp-zone fp-warehouse">Warehouse</div>
                                <div class="fp-zone fp-dock">Loading Dock</div>
                                <div class="fp-zone fp-utility">Utility Room</div>
                                <div class="fp-zone fp-it">IT Room</div>
                            </div>
                            <p class="placeholder-hint">In production, this would load actual CAD drawings or BIM models.</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showFacilityList() {
            document.getElementById('facility-details').classList.add('hidden');
            document.getElementById('facility-list').classList.remove('hidden');
        }

        // Search functionality
        document.getElementById('search-input').addEventListener('input', () => {
            // First, go back to list view if in details view
            showFacilityList();
            
            if (facilitiesData) {
                renderFacilityList(facilitiesData.features);
            }
        });

        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // First, go back to list view if in details view
                showFacilityList();
                
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.type;
                if (facilitiesData) {
                    renderFacilityList(facilitiesData.features);
                    
                    // Update map filter
                    if (currentFilter === 'all') {
                        map.setFilter('points', null);
                        map.setFilter('labels', null);
                    } else {
                        map.setFilter('points', ['==', ['get', 'type'], currentFilter]);
                        map.setFilter('labels', ['==', ['get', 'type'], currentFilter]);
                    }
                }
            });
        });
    </script>
</body>
</html>
