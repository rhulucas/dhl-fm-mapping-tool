<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faster 99 - Facility Management Tool</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
    <!-- Three.js for 3D BIM visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay">
        <div class="login-box">
            <div class="login-header">
                <h1>âš¡ Faster <span>99</span></h1>
                <p>Facility Management System</p>
            </div>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" placeholder="your.email@faster99.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <select id="login-role">
                        <option value="admin">Administrator</option>
                        <option value="manager">Facility Manager</option>
                        <option value="technician">Maintenance Tech</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                <button type="submit" class="login-btn">ğŸ” Sign In</button>
            </form>
            <p class="demo-hint">Demo: Enter any email/password to login</p>
        </div>
    </div>

    <div id="sidebar">
        <!-- Header -->
        <div class="header">
            <h1 class="logo">âš¡ Faster <span>99</span></h1>
            <p class="tagline">Facility Management Hub</p>
            <div id="login-prompt" class="login-prompt">
                <button onclick="showLoginModal()" class="signin-btn">ğŸ” Sign In</button>
            </div>
            <div id="user-info" class="user-info hidden">
                <span id="user-name">Guest</span>
                <button onclick="handleLogout()" class="logout-btn">Logout</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="facilities">ğŸ“ Facilities</button>
            <button class="nav-tab" data-tab="resources">ğŸ“š Resources</button>
            <button class="nav-tab" data-tab="dashboard">ğŸ“Š Dashboard</button>
            <button class="nav-tab" data-tab="tickets">ğŸ« Tickets</button>
            <button class="nav-tab" data-tab="data">ğŸ“¤ Data</button>
        </div>

        <!-- Tab: Facilities -->
        <div id="tab-facilities" class="tab-content active">
            <!-- Search & Filter -->
            <div class="search-section">
                <input type="text" id="search-input" placeholder="ğŸ” Search facilities...">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-type="all">All</button>
                    <button class="filter-btn" data-type="distribution">Distribution</button>
                    <button class="filter-btn" data-type="hub">Hub</button>
                    <button class="filter-btn" data-type="warehouse">Warehouse</button>
                    <button class="filter-btn" data-type="fulfillment">Fulfillment</button>
                    <button class="filter-btn" data-type="sorting">Sorting</button>
                    <button class="filter-btn" data-type="crossdock">Cross-Dock</button>
                    <button class="filter-btn" data-type="cold_storage">Cold Storage</button>
                    <button class="filter-btn" data-type="returns">Returns</button>
                </div>
            </div>

            <!-- Facility List -->
            <div id="facility-list">
                <p class="loading">Loading facilities...</p>
            </div>

            <!-- Facility Details Panel (hidden by default) -->
            <div id="facility-details" class="hidden">
                <button class="back-btn" onclick="showFacilityList()">â† Back to List</button>
                <div id="details-content"></div>
            </div>
        </div>

        <!-- Tab: Resources (REM, IT, Security, Risk) -->
        <div id="tab-resources" class="tab-content">
            <h2 class="tab-title">ğŸ“š Resource Center</h2>
            <p class="tab-description">Quick access to key department resources and support channels.</p>
            
            <div class="resource-card rem">
                <div class="resource-icon">ğŸ¢</div>
                <div class="resource-content">
                    <h3>REM - Real Estate Management</h3>
                    <p>Property leasing, space planning, and facility expansion requests.</p>
                    <ul class="resource-links">
                        <li><a href="#">ğŸ“‹ Space Request Form</a></li>
                        <li><a href="#">ğŸ“Š Lease Management Portal</a></li>
                        <li><a href="#">ğŸ“ Contact: rem@faster99.com</a></li>
                    </ul>
                </div>
            </div>

            <div class="resource-card it">
                <div class="resource-icon">ğŸ’»</div>
                <div class="resource-content">
                    <h3>IT Support</h3>
                    <p>Technical support, network issues, and system access requests.</p>
                    <ul class="resource-links">
                        <li><a href="#">ğŸ« Submit IT Ticket</a></li>
                        <li><a href="#">ğŸ“– Knowledge Base</a></li>
                        <li><a href="#">ğŸ“ Help Desk: 1-800-555-TECH</a></li>
                    </ul>
                </div>
            </div>

            <div class="resource-card security">
                <div class="resource-icon">ğŸ”’</div>
                <div class="resource-content">
                    <h3>Security</h3>
                    <p>Access control, surveillance, and emergency response coordination.</p>
                    <ul class="resource-links">
                        <li><a href="#">ğŸ”‘ Access Request Form</a></li>
                        <li><a href="#">ğŸ“¹ Surveillance Request</a></li>
                        <li><a href="#">ğŸš¨ Emergency: 1-800-555-SAFE</a></li>
                    </ul>
                </div>
            </div>

            <div class="resource-card risk">
                <div class="resource-icon">âš ï¸</div>
                <div class="resource-content">
                    <h3>Risk Management</h3>
                    <p>Insurance claims, compliance, and incident reporting.</p>
                    <ul class="resource-links">
                        <li><a href="#">ğŸ“ Incident Report Form</a></li>
                        <li><a href="#">ğŸ“‹ Insurance Claims Portal</a></li>
                        <li><a href="#">ğŸ“ Contact: risk@faster99.com</a></li>
                    </ul>
                </div>
            </div>

            <!-- Equipment Inventory Section -->
            <div class="resource-section">
                <h2 class="section-title">ğŸ“¦ Equipment Inventory</h2>
                <p class="section-desc">Real-time equipment status across all facilities</p>
                
                <div class="inventory-summary">
                    <div class="inventory-stat operational">
                        <span class="inv-number" id="inv-operational">0</span>
                        <span class="inv-label">Operational</span>
                    </div>
                    <div class="inventory-stat maintenance">
                        <span class="inv-number" id="inv-maintenance">0</span>
                        <span class="inv-label">Maintenance</span>
                    </div>
                    <div class="inventory-stat fault">
                        <span class="inv-number" id="inv-fault">0</span>
                        <span class="inv-label">Fault</span>
                    </div>
                </div>
                
                <div class="inventory-table-container">
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>Facility</th>
                                <th>Equipment</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Maintenance Calendar Section -->
            <div class="resource-section">
                <h2 class="section-title">ğŸ“… Maintenance Calendar</h2>
                <p class="section-desc">Upcoming scheduled maintenance and inspections</p>
                
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button class="cal-nav" onclick="changeMonth(-1)">â—€</button>
                        <span id="calendar-month">February 2026</span>
                        <button class="cal-nav" onclick="changeMonth(1)">â–¶</button>
                    </div>
                    <div class="calendar-weekdays">
                        <div class="cal-day-header">Sun</div>
                        <div class="cal-day-header">Mon</div>
                        <div class="cal-day-header">Tue</div>
                        <div class="cal-day-header">Wed</div>
                        <div class="cal-day-header">Thu</div>
                        <div class="cal-day-header">Fri</div>
                        <div class="cal-day-header">Sat</div>
                    </div>
                    <div class="calendar-grid" id="calendar-days"></div>
                </div>
                
                <div class="upcoming-maintenance">
                    <h3>ğŸ“‹ Upcoming Maintenance</h3>
                    <div id="upcoming-list">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Dashboard -->
        <div id="tab-dashboard" class="tab-content">
            <h2 class="tab-title">ğŸ“Š Facilities Dashboard</h2>
            <p class="tab-description">Overview of all facility metrics and statistics.</p>
            
            <div class="dashboard-stats">
                <div class="stat-card">
                    <span class="stat-number" id="stat-total">-</span>
                    <span class="stat-label">Total Facilities</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-sqft">-</span>
                    <span class="stat-label">Total Sq. Ft.</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="stat-employees">-</span>
                    <span class="stat-label">Total Employees</span>
                </div>
            </div>

            <div class="dashboard-section">
                <h3>ğŸ“ˆ Facilities by Type</h3>
                <div id="type-chart" class="type-chart"></div>
            </div>

            <div class="dashboard-section">
                <h3>ğŸ† Largest Facilities</h3>
                <div id="top-facilities" class="top-facilities"></div>
            </div>

            <div class="dashboard-section">
                <h3>ğŸ“ Geographic Coverage</h3>
                <div class="coverage-info" id="coverage-info">
                    <p>Loading coverage data...</p>
                </div>
            </div>

            <div class="dashboard-section">
                <h3>ğŸ—ºï¸ Facilities by State</h3>
                <div id="state-chart" class="type-chart"></div>
            </div>
        </div>

        <!-- Tab: Data Import -->
        <div id="tab-data" class="tab-content">
            <h2 class="tab-title">ğŸ“¤ Data Import</h2>
            <p class="tab-description">Import facility data from CSV or Excel files.</p>
            
            <div class="upload-section">
                <h3>ğŸ“ Upload CSV File</h3>
                <p class="upload-hint">Upload a CSV file with facility data to add to the map.</p>
                
                <div class="upload-area" id="upload-area">
                    <div class="upload-icon">ğŸ“„</div>
                    <p>Drag & drop a CSV file here</p>
                    <p class="upload-or">or</p>
                    <label class="upload-btn">
                        Choose File
                        <input type="file" id="csv-file" accept=".csv" hidden>
                    </label>
                </div>
                
                <div id="upload-status" class="upload-status hidden"></div>
            </div>
            
            <div class="template-section">
                <h3>ğŸ“‹ CSV Template</h3>
                <p>Your CSV file should have these columns:</p>
                <div class="template-columns">
                    <span class="col required">id</span>
                    <span class="col required">name</span>
                    <span class="col required">type</span>
                    <span class="col required">address</span>
                    <span class="col required">latitude</span>
                    <span class="col required">longitude</span>
                    <span class="col">size_sqft</span>
                    <span class="col">employees</span>
                    <span class="col">manager_name</span>
                    <span class="col">manager_email</span>
                    <span class="col">manager_phone</span>
                </div>
                <button class="download-template-btn" onclick="downloadTemplate()">
                    â¬‡ï¸ Download Template
                </button>
            </div>
            
            <div class="import-history">
                <h3>ğŸ“Š Current Data</h3>
                <div id="data-summary">
                    <p>Loading data summary...</p>
                </div>
            </div>
            
            <div class="export-section">
                <h3>ğŸ“¥ Export Data</h3>
                <p>Download facility data as CSV files for Excel.</p>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportFacilities()">
                        ğŸ“Š Export All Facilities
                    </button>
                    <button class="export-btn secondary" onclick="exportContacts()">
                        ğŸ‘¥ Export All Contacts
                    </button>
                </div>
            </div>
        </div>

        <!-- Tab: Tickets -->
        <div id="tab-tickets" class="tab-content">
            <h2 class="tab-title">ğŸ« Work Orders</h2>
            <p class="tab-description">Submit and track maintenance requests.</p>
            
            <div class="ticket-form-section">
                <h3>ğŸ“ Submit New Request</h3>
                <form id="ticket-form" onsubmit="submitTicket(event)">
                    <div class="form-group">
                        <label>Facility</label>
                        <select id="ticket-facility" required>
                            <option value="">Select a facility...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="ticket-category" required>
                            <option value="">Select category...</option>
                            <option value="hvac">HVAC Issue</option>
                            <option value="electrical">Electrical</option>
                            <option value="plumbing">Plumbing</option>
                            <option value="security">Security</option>
                            <option value="equipment">Equipment Malfunction</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="ticket-priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="ticket-title" placeholder="Brief description..." required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="ticket-description" placeholder="Detailed description of the issue..." rows="3"></textarea>
                    </div>
                    <button type="submit" class="submit-ticket-btn">ğŸ« Submit Request</button>
                </form>
            </div>
            
            <div class="ticket-list-section">
                <h3>ğŸ“‹ Recent Tickets</h3>
                <div class="ticket-filters">
                    <button class="ticket-filter active" data-status="all">All</button>
                    <button class="ticket-filter" data-status="open">Open</button>
                    <button class="ticket-filter" data-status="in_progress">In Progress</button>
                    <button class="ticket-filter" data-status="resolved">Resolved</button>
                </div>
                <div id="ticket-list">
                    <p class="no-tickets">No tickets yet. Submit your first request above!</p>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <!-- Address Search Control on Map -->
    <div id="geocoder-container" class="geocoder-container"></div>

    <script>
        // Configure Mapbox Token
        mapboxgl.accessToken = 'pk.eyJ1Ijoia2VsbHktMjM0IiwiYSI6ImNtbTJreTM2cTA4ZHUycXBydTRqaWp0eTkifQ.SVpQqcW7lvEdQ1zCXI-rvw';

        let facilitiesData = null;
        let currentFilter = 'all';
        let searchMarker = null;

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [-95.7, 37.0], // Center of US
            zoom: 4
        });

        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');

        // Add Geocoder (Address Search) control
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            placeholder: 'ğŸ” Search any address in the US...',
            countries: 'us',
            marker: false
        });

        document.getElementById('geocoder-container').appendChild(geocoder.onAdd(map));

        // Handle geocoder result
        geocoder.on('result', (e) => {
            // Remove existing search marker
            if (searchMarker) {
                searchMarker.remove();
            }
            
            // Add new marker
            searchMarker = new mapboxgl.Marker({ color: '#ff0000' })
                .setLngLat(e.result.center)
                .setPopup(new mapboxgl.Popup().setHTML(`
                    <strong>ğŸ“ Search Result</strong><br>
                    ${e.result.place_name}
                `))
                .addTo(map);
            
            searchMarker.togglePopup();
        });

        // Facility type colors
        const typeColors = {
            'distribution': '#e74c3c',
            'hub': '#3498db',
            'fulfillment': '#9b59b6',
            'sorting': '#e67e22',
            'warehouse': '#2ecc71',
            'crossdock': '#1abc9c',
            'service': '#f39c12',
            'returns': '#95a5a6',
            'cold_storage': '#00bcd4'
        };

        // Facility type labels
        const typeLabels = {
            'distribution': 'Distribution Center',
            'hub': 'Hub',
            'fulfillment': 'Fulfillment Center',
            'sorting': 'Sorting Facility',
            'warehouse': 'Warehouse',
            'crossdock': 'Cross-Dock',
            'service': 'Service Center',
            'returns': 'Returns Center',
            'cold_storage': 'Cold Storage'
        };

        // =============================================
        // USER AUTHENTICATION
        // =============================================
        
        let currentUser = null;
        
        // Check if user is logged in (but don't force login)
        function checkAuth() {
            const savedUser = localStorage.getItem('fm_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserUI();
            }
        }
        
        function showLoginModal() {
            document.getElementById('login-modal').classList.add('active');
        }
        
        function hideLoginModal() {
            document.getElementById('login-modal').classList.remove('active');
        }
        
        function updateUserUI() {
            const userInfo = document.getElementById('user-info');
            const loginPrompt = document.getElementById('login-prompt');
            
            if (currentUser) {
                userInfo.classList.remove('hidden');
                loginPrompt.classList.add('hidden');
                document.getElementById('user-name').textContent = currentUser.email.split('@')[0];
            } else {
                userInfo.classList.add('hidden');
                loginPrompt.classList.remove('hidden');
            }
        }
        
        // Check if action requires login
        function requireLogin(action) {
            if (!currentUser) {
                alert('Please sign in to ' + action);
                showLoginModal();
                return false;
            }
            return true;
        }
        
        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const role = document.getElementById('login-role').value;
            
            // For demo purposes, accept any credentials
            currentUser = {
                email: email,
                role: role,
                loginTime: new Date().toISOString()
            };
            
            localStorage.setItem('fm_user', JSON.stringify(currentUser));
            hideLoginModal();
            updateUserUI();
            
            // Check if there's a pending issue to report
            if (pendingIssue) {
                const issue = pendingIssue;
                pendingIssue = null;
                processIssueReport(issue);
            }
        }
        
        function handleLogout() {
            localStorage.removeItem('fm_user');
            currentUser = null;
            updateUserUI();
        }
        
        // Check auth on page load (don't force login)
        document.addEventListener('DOMContentLoaded', checkAuth);

        // API Configuration - fallback to local data if API unavailable
        const API_URL = 'https://faster99-api-eafbb2bah6hnguc4.eastus2-01.azurewebsites.net';
        let useLocalStorage = false; // Will be set to true if API fails

        map.on('load', () => {
            // Try API first, fallback to local data.json
            fetch(API_URL + '/api/facilities')
                .then(response => {
                    if (!response.ok) throw new Error('API unavailable');
                    return response.json();
                })
                .catch(() => {
                    console.log('API unavailable, loading local data.json');
                    useLocalStorage = true;
                    return fetch('data.json').then(r => {
                        if (!r.ok) throw new Error('data.json not found');
                        return r.json();
                    });
                })
                .then(data => {
                    facilitiesData = data;
                    
                    map.addSource('facilities', {
                        type: 'geojson',
                        data: data
                    });

                    // Add circle layer for facility points
                    map.addLayer({
                        id: 'points',
                        type: 'circle',
                        source: 'facilities',
                        paint: {
                            'circle-radius': 10,
                            'circle-color': [
                                'match',
                                ['get', 'type'],
                                'distribution', typeColors.distribution,
                                'hub', typeColors.hub,
                                'fulfillment', typeColors.fulfillment,
                                'sorting', typeColors.sorting,
                                'warehouse', typeColors.warehouse,
                                'crossdock', typeColors.crossdock,
                                'service', typeColors.service,
                                'returns', typeColors.returns,
                                'cold_storage', typeColors.cold_storage,
                                '#999999'
                            ],
                            'circle-stroke-width': 3,
                            'circle-stroke-color': '#ffffff'
                        }
                    });

                    // Add labels
                    map.addLayer({
                        id: 'labels',
                        type: 'symbol',
                        source: 'facilities',
                        layout: {
                            'text-field': ['get', 'id'],
                            'text-size': 10,
                            'text-offset': [0, 1.5]
                        },
                        paint: {
                            'text-color': '#333'
                        }
                    });

                    // Render facility list
                    renderFacilityList(data.features);
                    
                    // Render dashboard
                    renderDashboard(data.features);
                    
                    // Update data summary
                    updateDataSummary();
                    
                    // Initialize ticket system
                    populateFacilityDropdown();
                    loadTickets();
                    
                    // Initialize resources
                    setTimeout(() => {
                        updateInventory();
                        renderCalendar();
                    }, 500);

                    // Click interaction - show facility details
                    map.on('click', 'points', (e) => {
                        const props = e.features[0].properties;
                        // Switch to facilities tab
                        switchTab('facilities');
                        showFacilityDetails(props);
                    });

                    // Change cursor style on hover
                    map.on('mouseenter', 'points', () => map.getCanvas().style.cursor = 'pointer');
                    map.on('mouseleave', 'points', () => map.getCanvas().style.cursor = '');
                })
                .catch(error => {
                    console.error('Failed to load facilities:', error);
                    document.getElementById('facility-list').innerHTML = 
                        '<p style="color: #e74c3c; padding: 20px;">Failed to load facilities. Please refresh the page.</p>';
                });
        });

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchTab(tab.dataset.tab);
            });
        });

        // =============================================
        // DATA IMPORT FUNCTIONS
        // =============================================
        
        // Update data summary on Data tab
        function updateDataSummary() {
            if (!facilitiesData) return;
            
            const features = facilitiesData.features || [];
            const byType = {};
            features.forEach(f => {
                const type = f.properties.type || 'unknown';
                byType[type] = (byType[type] || 0) + 1;
            });
            
            document.getElementById('data-summary').innerHTML = `
                <div class="data-stats">
                    <div class="data-stat">
                        <span class="data-stat-value">${features.length}</span>
                        <span class="data-stat-label">Total Facilities</span>
                    </div>
                    <div class="data-stat">
                        <span class="data-stat-value">${Object.keys(byType).length}</span>
                        <span class="data-stat-label">Facility Types</span>
                    </div>
                </div>
                <div class="type-breakdown">
                    ${Object.entries(byType).map(([type, count]) => `
                        <div class="type-row">
                            <span class="type-name">${typeLabels[type] || type}</span>
                            <span class="type-count">${count}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // =============================================
        // EQUIPMENT INVENTORY
        // =============================================
        
        const equipmentTypes = [
            { name: 'HVAC Unit 1', type: 'hvac' },
            { name: 'HVAC Unit 2', type: 'hvac' },
            { name: 'Fire Suppression', type: 'fire' },
            { name: 'Conveyor System', type: 'conveyor' },
            { name: 'Security Camera', type: 'security' },
            { name: 'Forklift Charger', type: 'forklift' },
            { name: 'Lighting System', type: 'lighting' }
        ];

        function updateInventory() {
            if (!facilitiesData) return;
            
            const inventoryData = [];
            let operational = 0, maintenance = 0, fault = 0;
            
            // Generate equipment status for each facility
            facilitiesData.features.slice(0, 20).forEach(f => {
                const facilityId = f.properties.id;
                
                equipmentTypes.forEach(eq => {
                    // Check if there's a ticket for this equipment at this facility
                    const ticket = allTickets.find(t => 
                        t.facility_id === facilityId && 
                        t.title.includes(eq.name)
                    );
                    
                    let status = 'operational';
                    if (ticket) {
                        status = ticket.status === 'resolved' ? 'operational' : 
                                 ticket.status === 'in_progress' ? 'maintenance' : 'fault';
                    }
                    
                    // Add some random variation for demo
                    if (!ticket && Math.random() < 0.05) {
                        status = 'maintenance';
                    }
                    
                    if (status === 'operational') operational++;
                    else if (status === 'maintenance') maintenance++;
                    else fault++;
                    
                    inventoryData.push({
                        facility: facilityId,
                        facilityName: f.properties.name,
                        equipment: eq.name,
                        type: eq.type,
                        status: status
                    });
                });
            });
            
            // Update summary stats
            document.getElementById('inv-operational').textContent = operational;
            document.getElementById('inv-maintenance').textContent = maintenance;
            document.getElementById('inv-fault').textContent = fault;
            
            // Populate table (show non-operational first)
            const tbody = document.getElementById('inventory-body');
            const sortedData = inventoryData.sort((a, b) => {
                const order = { fault: 0, maintenance: 1, operational: 2 };
                return order[a.status] - order[b.status];
            }).slice(0, 50);
            
            tbody.innerHTML = sortedData.map(item => `
                <tr>
                    <td>${item.facility}</td>
                    <td>${item.equipment}</td>
                    <td>${item.type.toUpperCase()}</td>
                    <td><span class="status-pill ${item.status}">${item.status}</span></td>
                    <td><button class="view-3d-btn" onclick="goToFacility3D('${item.facility}')">View 3D</button></td>
                </tr>
            `).join('');
        }

        function goToFacility3D(facilityId) {
            // Go to facility and open 3D view
            if (facilitiesData) {
                const feature = facilitiesData.features.find(f => f.properties.id === facilityId);
                if (feature) {
                    switchTab('facilities');
                    showFacilityDetails(feature.properties);
                    setTimeout(() => showFloorPlan(facilityId), 300);
                }
            }
        }

        // =============================================
        // MAINTENANCE CALENDAR
        // =============================================
        
        let currentCalendarDate = new Date();
        
        // Sample maintenance schedule
        const maintenanceSchedule = [
            { date: new Date(2026, 1, 28), title: 'HVAC Inspection', facility: 'DC-001', type: 'Preventive' },
            { date: new Date(2026, 2, 3), title: 'Fire System Test', facility: 'HB-002', type: 'Safety' },
            { date: new Date(2026, 2, 5), title: 'Conveyor Maintenance', facility: 'WH-018', type: 'Preventive' },
            { date: new Date(2026, 2, 10), title: 'Security Audit', facility: 'CS-006', type: 'Compliance' },
            { date: new Date(2026, 2, 15), title: 'Electrical Inspection', facility: 'DC-005', type: 'Safety' },
            { date: new Date(2026, 2, 20), title: 'Loading Dock Service', facility: 'HB-074', type: 'Preventive' },
            { date: new Date(2026, 2, 25), title: 'Generator Test', facility: 'WH-045', type: 'Safety' },
            { date: new Date(2026, 3, 1), title: 'Quarterly HVAC Service', facility: 'DC-001', type: 'Preventive' },
            { date: new Date(2026, 3, 8), title: 'Roof Inspection', facility: 'HB-002', type: 'Preventive' },
            { date: new Date(2026, 3, 15), title: 'Pest Control', facility: 'WH-063', type: 'Preventive' }
        ];

        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                               'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month').textContent = `${monthNames[month]} ${year}`;
            
            // Get first day of month and total days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            const today = new Date();
            let html = '';
            
            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                html += `<div class="cal-day other-month">${daysInPrevMonth - i}</div>`;
            }
            
            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = date.toDateString() === today.toDateString();
                const hasEvent = maintenanceSchedule.some(m => 
                    m.date.toDateString() === date.toDateString()
                );
                
                let classes = 'cal-day';
                if (isToday) classes += ' today';
                if (hasEvent) classes += ' has-event';
                
                html += `<div class="${classes}" onclick="showDayEvents(${year}, ${month}, ${day})">${day}</div>`;
            }
            
            // Next month days
            const totalCells = firstDay + daysInMonth;
            const remaining = 42 - totalCells;
            for (let i = 1; i <= remaining && totalCells + i <= 42; i++) {
                html += `<div class="cal-day other-month">${i}</div>`;
            }
            
            document.getElementById('calendar-days').innerHTML = html;
            
            // Update upcoming list
            renderUpcomingMaintenance();
        }

        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function showDayEvents(year, month, day) {
            const date = new Date(year, month, day);
            const events = maintenanceSchedule.filter(m => 
                m.date.toDateString() === date.toDateString()
            );
            
            if (events.length > 0) {
                alert(events.map(e => `${e.title} at ${e.facility}`).join('\n'));
            }
        }

        function renderUpcomingMaintenance() {
            const today = new Date();
            const upcoming = maintenanceSchedule
                .filter(m => m.date >= today)
                .sort((a, b) => a.date - b.date)
                .slice(0, 5);
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            document.getElementById('upcoming-list').innerHTML = upcoming.map(m => `
                <div class="maintenance-item">
                    <div class="maint-date">
                        <span class="maint-day">${m.date.getDate()}</span>
                        <span class="maint-month">${monthNames[m.date.getMonth()]}</span>
                    </div>
                    <div class="maint-details">
                        <h4>${m.title}</h4>
                        <p>ğŸ“ ${m.facility}</p>
                        <span class="maint-type">${m.type}</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Download CSV template
        function downloadTemplate() {
            const template = `id,name,type,address,latitude,longitude,size_sqft,employees,manager_name,manager_email,manager_phone
FAC-001,Main Warehouse,warehouse,123 Main St Chicago IL,41.8781,-87.6298,50000,120,John Smith,j.smith@company.com,312-555-1234
FAC-002,Distribution Center,distribution,456 Oak Ave Dallas TX,32.7767,-96.7970,75000,200,Mike Johnson,m.johnson@company.com,214-555-5678`;
            
            const blob = new Blob([template], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'facility_template.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Export facilities to CSV
        function exportFacilities() {
            window.open(API_URL + '/api/export/csv', '_blank');
        }
        
        // Export contacts to CSV
        function exportContacts() {
            window.open(API_URL + '/api/export/contacts', '_blank');
        }
        
        // =============================================
        // TICKET SYSTEM FUNCTIONS
        // =============================================
        
        let allTickets = [];
        let currentTicketFilter = 'all';
        
        // Populate facility dropdown for tickets
        function populateFacilityDropdown() {
            if (!facilitiesData) return;
            
            const select = document.getElementById('ticket-facility');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select a facility...</option>';
            
            facilitiesData.features.forEach(f => {
                const option = document.createElement('option');
                option.value = f.properties.id;
                option.textContent = `${f.properties.id} - ${f.properties.name}`;
                select.appendChild(option);
            });
        }
        
        // Submit new ticket
        function submitTicket(event) {
            event.preventDefault();

            if (!requireLogin('submit a ticket')) return;

            const ticket = {
                id: 'TKT-' + String(allTickets.length + 1).padStart(4, '0'),
                facility_id: document.getElementById('ticket-facility').value,
                category: document.getElementById('ticket-category').value,
                priority: document.getElementById('ticket-priority').value,
                title: document.getElementById('ticket-title').value,
                description: document.getElementById('ticket-description').value,
                status: 'open',
                created_at: new Date().toISOString()
            };

            if (useLocalStorage) {
                // Save to localStorage
                allTickets.push(ticket);
                saveTicketsToLocal();
                alert('Ticket created: ' + ticket.id);
                document.getElementById('ticket-form').reset();
                renderTickets();
                updateInventory();
                return;
            }

            fetch(API_URL + '/api/tickets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ticket)
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Ticket created: ' + result.ticket.id);
                    document.getElementById('ticket-form').reset();
                    loadTickets();
                }
            })
            .catch(error => {
                // Fallback to localStorage
                allTickets.push(ticket);
                saveTicketsToLocal();
                alert('Ticket created locally: ' + ticket.id);
                document.getElementById('ticket-form').reset();
                renderTickets();
                updateInventory();
            });
        }
        
        // Load tickets from API
        function loadTickets() {
            if (useLocalStorage) {
                // Load from localStorage
                const stored = localStorage.getItem('fm_tickets');
                allTickets = stored ? JSON.parse(stored) : [];
                renderTickets();
                return;
            }
            
            fetch(API_URL + '/api/tickets')
                .then(response => response.json())
                .then(result => {
                    allTickets = result.tickets || [];
                    renderTickets();
                })
                .catch(error => {
                    console.error('Failed to load tickets:', error);
                    // Fallback to localStorage
                    const stored = localStorage.getItem('fm_tickets');
                    allTickets = stored ? JSON.parse(stored) : [];
                    renderTickets();
                });
        }
        
        function saveTicketsToLocal() {
            localStorage.setItem('fm_tickets', JSON.stringify(allTickets));
        }
        
        // Render ticket list
        function renderTickets() {
            const list = document.getElementById('ticket-list');
            if (!list) return;
            
            let filtered = allTickets;
            if (currentTicketFilter !== 'all') {
                filtered = allTickets.filter(t => t.status === currentTicketFilter);
            }
            
            if (filtered.length === 0) {
                list.innerHTML = '<p class="no-tickets">No tickets found.</p>';
                return;
            }
            
            list.innerHTML = filtered.map(t => `
                <div class="ticket-card ${t.priority}">
                    <div class="ticket-header">
                        <span class="ticket-id">${t.id}</span>
                        <span class="ticket-status ${t.status}">${t.status.replace('_', ' ')}</span>
                    </div>
                    <h4 class="ticket-title">${t.title}</h4>
                    <div class="ticket-meta">
                        <span class="facility-link" onclick="goToFacility('${t.facility_id}')">ğŸ“ ${t.facility_id}</span>
                        <span>ğŸ·ï¸ ${t.category}</span>
                        <span class="priority-badge ${t.priority}">${t.priority}</span>
                    </div>
                    <p class="ticket-desc">${t.description || 'No description'}</p>
                    <div class="ticket-actions">
                        ${t.status === 'open' ? `<button onclick="updateTicketStatus('${t.id}', 'in_progress')">Start Work</button>` : ''}
                        ${t.status === 'in_progress' ? `<button onclick="updateTicketStatus('${t.id}', 'resolved')">Mark Resolved</button>` : ''}
                        <button class="delete-btn" onclick="deleteTicket('${t.id}')">ğŸ—‘ï¸ Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        // Go to facility from ticket
        function goToFacility(facilityId) {
            // Switch to facilities tab
            switchTab('facilities');
            
            // Find and select the facility
            if (facilitiesData) {
                const feature = facilitiesData.features.find(f => f.properties.id === facilityId);
                if (feature) {
                    // Show facility details
                    showFacilityDetails(feature.properties);
                    
                    // Fly to location on map
                    map.flyTo({
                        center: feature.geometry.coordinates,
                        zoom: 12
                    });
                }
            }
        }

        // Update ticket status
        function updateTicketStatus(ticketId, newStatus) {
            if (useLocalStorage) {
                const ticket = allTickets.find(t => t.id === ticketId);
                if (ticket) {
                    ticket.status = newStatus;
                    saveTicketsToLocal();
                    renderTickets();
                    updateInventory();
                }
                return;
            }
            
            fetch(API_URL + '/api/tickets/' + ticketId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    loadTickets();
                }
            })
            .catch(error => {
                // Fallback to localStorage
                const ticket = allTickets.find(t => t.id === ticketId);
                if (ticket) {
                    ticket.status = newStatus;
                    saveTicketsToLocal();
                    renderTickets();
                    updateInventory();
                }
            });
        }

        // Delete ticket
        function deleteTicket(ticketId) {
            if (!confirm('Are you sure you want to delete this ticket?')) {
                return;
            }

            if (useLocalStorage) {
                allTickets = allTickets.filter(t => t.id !== ticketId);
                saveTicketsToLocal();
                renderTickets();
                updateInventory();
                return;
            }

            fetch(API_URL + '/api/tickets/' + ticketId, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    loadTickets();
                }
            })
            .catch(error => {
                // Fallback to localStorage
                allTickets = allTickets.filter(t => t.id !== ticketId);
                saveTicketsToLocal();
                renderTickets();
                updateInventory();
            });
        }
        
        // Setup ticket filter listeners
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.ticket-filter').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.ticket-filter').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTicketFilter = btn.dataset.status;
                    renderTickets();
                });
            });
        });
        
        // Handle file upload
        function handleFileUpload(file) {
            if (!requireLogin('upload data')) return;
            
            if (!file || !file.name.endsWith('.csv')) {
                showUploadStatus('Please upload a CSV file.', 'error');
                return;
            }
            
            showUploadStatus('Uploading and processing...', 'info');
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch(API_URL + '/api/upload/csv', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    showUploadStatus('Error: ' + result.error, 'error');
                } else {
                    showUploadStatus(`Success! Imported ${result.count} facilities.`, 'success');
                    // Optionally update the map with new data
                    console.log('Imported data:', result.data);
                }
            })
            .catch(error => {
                showUploadStatus('Upload failed: ' + error.message, 'error');
            });
        }
        
        function showUploadStatus(message, type) {
            const status = document.getElementById('upload-status');
            status.className = `upload-status ${type}`;
            status.textContent = message;
            status.classList.remove('hidden');
        }
        
        // Setup file upload listeners
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('csv-file');
            const uploadArea = document.getElementById('upload-area');
            
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files[0]) {
                        handleFileUpload(e.target.files[0]);
                    }
                });
            }
            
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    if (e.dataTransfer.files[0]) {
                        handleFileUpload(e.dataTransfer.files[0]);
                    }
                });
            }
        });

        // Render dashboard statistics
        function renderDashboard(features) {
            // Total stats
            const totalFacilities = features.length;
            const totalSqft = features.reduce((sum, f) => sum + f.properties.size_sqft, 0);
            const totalEmployees = features.reduce((sum, f) => sum + f.properties.employees, 0);

            document.getElementById('stat-total').textContent = totalFacilities;
            document.getElementById('stat-sqft').textContent = (totalSqft / 1000000).toFixed(2) + 'M';
            document.getElementById('stat-employees').textContent = totalEmployees.toLocaleString();

            // Facilities by type chart
            const typeCounts = {};
            features.forEach(f => {
                const type = f.properties.type;
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            const chartContainer = document.getElementById('type-chart');
            chartContainer.innerHTML = Object.entries(typeCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([type, count]) => {
                    const percentage = (count / totalFacilities * 100).toFixed(0);
                    const color = typeColors[type] || '#999';
                    return `
                        <div class="chart-bar">
                            <div class="chart-label">${typeLabels[type] || type}</div>
                            <div class="chart-bar-container">
                                <div class="chart-bar-fill" style="width: ${percentage}%; background: ${color}"></div>
                                <span class="chart-value">${count}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            // Top facilities by size
            const topFacilities = [...features]
                .sort((a, b) => b.properties.size_sqft - a.properties.size_sqft)
                .slice(0, 5);

            document.getElementById('top-facilities').innerHTML = topFacilities.map((f, i) => {
                const p = f.properties;
                const color = typeColors[p.type] || '#999';
                return `
                    <div class="top-facility-item" onclick="selectFacility('${p.id}'); switchTab('facilities');">
                        <span class="top-rank">#${i + 1}</span>
                        <div class="top-info">
                            <span class="top-name">${p.name}</span>
                            <span class="top-size">${p.size_sqft.toLocaleString()} sqft</span>
                        </div>
                        <span class="top-badge" style="background:${color}">${p.type}</span>
                    </div>
                `;
            }).join('');

            // Facilities by state
            const stateCounts = {};
            features.forEach(f => {
                const address = f.properties.address;
                const state = address.split(',').pop().trim();
                stateCounts[state] = (stateCounts[state] || 0) + 1;
            });

            const stateColors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#95a5a6'];
            const stateChartContainer = document.getElementById('state-chart');
            stateChartContainer.innerHTML = Object.entries(stateCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(([state, count], index) => {
                    const percentage = (count / totalFacilities * 100).toFixed(0);
                    const color = stateColors[index % stateColors.length];
                    return `
                        <div class="chart-bar">
                            <div class="chart-label">${state}</div>
                            <div class="chart-bar-container">
                                <div class="chart-bar-fill" style="width: ${percentage}%; background: ${color}"></div>
                                <span class="chart-value">${count}</span>
                            </div>
                        </div>
                    `;
                }).join('');

            // Geographic coverage info
            const uniqueStates = Object.keys(stateCounts).length;
            document.getElementById('coverage-info').innerHTML = `
                <p><strong>${uniqueStates}</strong> states covered across the US</p>
                <p><strong>${totalFacilities}</strong> facilities nationwide</p>
                <p>Average <strong>${Math.round(totalEmployees / uniqueStates)}</strong> employees per state</p>
            `;
        }

        // Render facility list in sidebar
        function renderFacilityList(features) {
            const listContainer = document.getElementById('facility-list');
            
            const filteredFeatures = features.filter(f => {
                const matchesFilter = currentFilter === 'all' || f.properties.type === currentFilter;
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const matchesSearch = !searchTerm || 
                    f.properties.name.toLowerCase().includes(searchTerm) ||
                    f.properties.id.toLowerCase().includes(searchTerm) ||
                    f.properties.address.toLowerCase().includes(searchTerm);
                return matchesFilter && matchesSearch;
            });

            if (filteredFeatures.length === 0) {
                listContainer.innerHTML = '<p class="no-results">No facilities found</p>';
                return;
            }

            listContainer.innerHTML = filteredFeatures.map(f => {
                const p = f.properties;
                const color = typeColors[p.type] || '#999';
                return `
                    <div class="facility-card" onclick="selectFacility('${p.id}')">
                        <div class="facility-header">
                            <span class="facility-badge" style="background:${color}">${p.id}</span>
                            <span class="facility-type">${typeLabels[p.type] || p.type}</span>
                        </div>
                        <h3 class="facility-name">${p.name}</h3>
                        <p class="facility-address">${p.address}</p>
                        <div class="facility-stats">
                            <span>ğŸ“¦ ${p.size_sqft.toLocaleString()} sqft</span>
                            <span>ğŸ‘¥ ${p.employees} employees</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Select facility from list
        function selectFacility(id) {
            const feature = facilitiesData.features.find(f => f.properties.id === id);
            if (feature) {
                // Fly to location
                map.flyTo({
                    center: feature.geometry.coordinates,
                    zoom: 12
                });
                // Show details
                showFacilityDetails(feature.properties);
            }
        }

        // Show facility details panel
        function showFacilityDetails(props) {
            // Parse JSON strings if needed
            const contacts = typeof props.contacts === 'string' ? JSON.parse(props.contacts) : props.contacts;
            const equipment = typeof props.equipment === 'string' ? JSON.parse(props.equipment) : props.equipment;
            const procedures = typeof props.emergency_procedures === 'string' ? JSON.parse(props.emergency_procedures) : props.emergency_procedures;
            
            const color = typeColors[props.type] || '#999';

            document.getElementById('facility-list').classList.add('hidden');
            document.getElementById('facility-details').classList.remove('hidden');
            
            document.getElementById('details-content').innerHTML = `
                <div class="detail-header" style="border-left: 4px solid ${color}">
                    <span class="detail-badge" style="background:${color}">${props.id}</span>
                    <h2>${props.name}</h2>
                    <p class="detail-type">${typeLabels[props.type] || props.type}</p>
                    <p class="detail-address">ğŸ“ ${props.address}</p>
                </div>

                <div class="detail-section">
                    <h3>ğŸ“Š Facility Info</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Size</span>
                            <span class="info-value">${props.size_sqft.toLocaleString()} sqft</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Employees</span>
                            <span class="info-value">${props.employees}</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section collapsible">
                    <h3 class="section-toggle" onclick="toggleSection(this)">
                        <span>ğŸ‘¥ Key Contacts</span>
                        <span class="toggle-icon">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <div class="contacts-grid">
                            ${renderContact('Facility Manager', contacts.facility_manager, 'ğŸ¢')}
                            ${renderContact('IT Support', contacts.it_support, 'ğŸ’»')}
                            ${renderContact('Maintenance', contacts.maintenance, 'ğŸ”§')}
                            ${renderContact('Security', contacts.security, 'ğŸ”’')}
                        </div>
                    </div>
                </div>

                <div class="detail-section collapsible">
                    <h3 class="section-toggle" onclick="toggleSection(this)">
                        <span>âš™ï¸ Equipment</span>
                        <span class="toggle-icon">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <ul class="equipment-list">
                            ${equipment.map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <div class="detail-section collapsible">
                    <h3 class="section-toggle" onclick="toggleSection(this)">
                        <span>ğŸš¨ Emergency Procedures</span>
                        <span class="toggle-icon">â–¼</span>
                    </h3>
                    <div class="section-content collapsed">
                        <p class="section-hint">Select an issue type to see troubleshooting steps:</p>
                        <div class="emergency-buttons">
                            ${Object.keys(procedures).map(key => `
                                <button class="emergency-btn" onclick="showProcedure('${key}', this)">
                                    ${getEmergencyIcon(key)} ${formatProcedureName(key)}
                                </button>
                            `).join('')}
                        </div>
                        <div id="procedure-steps" class="procedure-steps hidden"></div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>ğŸ—ºï¸ Floor Plan</h3>
                    <button class="floor-plan-btn" onclick="showFloorPlan('${props.id}')">
                        View Floor Plan
                    </button>
                </div>
            `;

            // Store procedures in window for access
            window.currentProcedures = procedures;
        }

        function renderContact(role, contact, icon) {
            return `
                <div class="contact-card">
                    <div class="contact-icon">${icon}</div>
                    <div class="contact-info">
                        <span class="contact-role">${role}</span>
                        <span class="contact-name">${contact.name}</span>
                        <a href="mailto:${contact.email}" class="contact-email">${contact.email}</a>
                        <a href="tel:${contact.phone}" class="contact-phone">${contact.phone}</a>
                    </div>
                </div>
            `;
        }

        function getEmergencyIcon(key) {
            const icons = {
                'power_outage': 'âš¡',
                'hvac_failure': 'â„ï¸',
                'security_breach': 'ğŸš¨',
                'water_leak': 'ğŸ’§',
                'fire_alarm': 'ğŸ”¥',
                'equipment_malfunction': 'âš™ï¸',
                'conveyor_jam': 'ğŸ”„',
                'dock_door_malfunction': 'ğŸšª',
                'weather_emergency': 'ğŸŒªï¸',
                'forklift_accident': 'ğŸšœ',
                'structural_issue': 'ğŸ—ï¸',
                'fuel_spill': 'â›½',
                'vehicle_fire': 'ğŸš’',
                'hazmat_package': 'â˜¢ï¸',
                'system_failure': 'ğŸ’»',
                'temperature_alarm': 'ğŸŒ¡ï¸',
                'refrigerant_leak': 'â„ï¸',
                'vehicle_accident': 'ğŸš—',
                'severe_weather': 'â›ˆï¸'
            };
            return icons[key] || 'âš ï¸';
        }

        function formatProcedureName(key) {
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function toggleSection(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.toggle-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.textContent = 'â–²';
                header.classList.add('expanded');
            } else {
                content.classList.add('collapsed');
                icon.textContent = 'â–¼';
                header.classList.remove('expanded');
            }
        }

        function showProcedure(key, btn) {
            const container = document.getElementById('procedure-steps');
            
            // If clicking the same active button, collapse it
            if (btn.classList.contains('active')) {
                btn.classList.remove('active');
                container.classList.add('hidden');
                container.innerHTML = '';
                return;
            }

            // Update button states
            document.querySelectorAll('.emergency-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const steps = window.currentProcedures[key];
            container.classList.remove('hidden');
            container.innerHTML = `
                <h4>${getEmergencyIcon(key)} ${formatProcedureName(key)}</h4>
                <ol class="steps-list">
                    ${steps.map(step => `<li>${step}</li>`).join('')}
                </ol>
            `;
        }

        function showFloorPlan(facilityId) {
            // Store current facility ID for report issue
            current3DFacilityId = facilityId;
            currentEquipmentData = null;
            
            // Create modal for 3D floor plan
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'floor-plan-modal';
            modal.innerHTML = `
                <div class="modal-content modal-3d">
                    <button class="modal-close" onclick="cleanup3DScene(); this.parentElement.parentElement.remove()">Ã—</button>
                    <h2>ğŸ—ï¸ 3D Floor Plan - ${facilityId}</h2>
                    <div class="bim-toolbar">
                        <button class="bim-btn active" onclick="setViewMode('3d')">3D View</button>
                        <button class="bim-btn" onclick="setViewMode('top')">Top View</button>
                        <button class="bim-btn" onclick="setViewMode('front')">Front View</button>
                        <span class="bim-hint">ğŸ–±ï¸ Drag to rotate | Scroll to zoom</span>
                    </div>
                    <div class="bim-viewer-wrapper">
                        <div id="threejs-container" class="threejs-container"></div>
                        <div id="equipment-info" class="equipment-info hidden"></div>
                        <div class="equipment-legend">
                            <span class="legend-item"><span class="status-dot green"></span> OK</span>
                            <span class="legend-item"><span class="status-dot yellow"></span> Maint</span>
                            <span class="legend-item"><span class="status-dot red"></span> Fault</span>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Initialize 3D scene
            setTimeout(() => init3DScene(facilityId), 100);
        }
        
        let scene, camera, renderer, controls;
        let equipmentObjects = [];
        let current3DFacilityId = null;
        let currentEquipmentData = null;
        
        function init3DScene(facilityId) {
            const container = document.getElementById('threejs-container');
            if (!container) return;
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            
            // Camera
            camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            camera.position.set(30, 25, 30);
            
            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(width, height);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(20, 30, 20);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // Grid
            const gridHelper = new THREE.GridHelper(50, 50, 0xcccccc, 0xe0e0e0);
            scene.add(gridHelper);
            
            // Build warehouse model
            buildWarehouse();
            
            // Add equipment
            addEquipment();
            
            // Animation loop
            animate();
            
            // Raycaster for click detection
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            
            renderer.domElement.addEventListener('click', (event) => {
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / height) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(equipmentObjects);
                
                if (intersects.length > 0) {
                    const obj = intersects[0].object;
                    showEquipmentInfo(obj.userData);
                }
            });
        }
        
        function buildWarehouse() {
            // Floor
            const floorGeometry = new THREE.BoxGeometry(40, 0.5, 30);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0xe0e0e0 });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.position.y = -0.25;
            floor.receiveShadow = true;
            scene.add(floor);
            
            // Walls
            const wallMaterial = new THREE.MeshLambertMaterial({ color: 0xcccccc, transparent: true, opacity: 0.3 });
            
            // Back wall
            const backWall = new THREE.Mesh(new THREE.BoxGeometry(40, 8, 0.3), wallMaterial);
            backWall.position.set(0, 4, -15);
            scene.add(backWall);
            
            // Side walls
            const leftWall = new THREE.Mesh(new THREE.BoxGeometry(0.3, 8, 30), wallMaterial);
            leftWall.position.set(-20, 4, 0);
            scene.add(leftWall);
            
            const rightWall = new THREE.Mesh(new THREE.BoxGeometry(0.3, 8, 30), wallMaterial);
            rightWall.position.set(20, 4, 0);
            scene.add(rightWall);
            
            // Office area (corner)
            const officeMaterial = new THREE.MeshLambertMaterial({ color: 0x4a90d9 });
            const office = new THREE.Mesh(new THREE.BoxGeometry(10, 4, 8), officeMaterial);
            office.position.set(-15, 2, -11);
            office.castShadow = true;
            scene.add(office);
            
            // Add label
            addLabel('Office', -15, 5, -11);
            
            // Loading dock
            const dockMaterial = new THREE.MeshLambertMaterial({ color: 0xf39c12 });
            const dock = new THREE.Mesh(new THREE.BoxGeometry(15, 0.3, 5), dockMaterial);
            dock.position.set(10, 0.15, 12.5);
            scene.add(dock);
            addLabel('Loading Dock', 10, 2, 12.5);
            
            // Storage racks
            const rackMaterial = new THREE.MeshLambertMaterial({ color: 0x7f8c8d });
            for (let i = 0; i < 3; i++) {
                const rack = new THREE.Mesh(new THREE.BoxGeometry(2, 5, 20), rackMaterial);
                rack.position.set(-5 + i * 8, 2.5, -2);
                rack.castShadow = true;
                scene.add(rack);
            }
            addLabel('Storage Racks', 3, 6, -2);
        }
        
        function addEquipment() {
            // Base equipment list - all start as operational
            const equipment = [
                { name: 'HVAC Unit 1', type: 'hvac', x: -18, y: 3, z: 5, status: 'operational' },
                { name: 'HVAC Unit 2', type: 'hvac', x: 18, y: 3, z: -5, status: 'operational' },
                { name: 'Conveyor System', type: 'conveyor', x: 5, y: 1, z: 8, status: 'operational' },
                { name: 'Fire Suppression', type: 'fire', x: 0, y: 6, z: 0, status: 'operational' },
                { name: 'Electrical Panel', type: 'electrical', x: -18, y: 2, z: -10, status: 'operational' },
                { name: 'Forklift Charger', type: 'charger', x: 15, y: 0.5, z: -10, status: 'operational' },
                { name: 'Security Camera', type: 'security', x: -19, y: 7, z: 14, status: 'operational' },
                { name: 'IT Server Rack', type: 'it', x: -12, y: 2, z: -13, status: 'operational' }
            ];
            
            // Update equipment status based on tickets
            allTickets.forEach(ticket => {
                const category = ticket.category;
                const ticketStatus = ticket.status;
                
                // Map ticket categories to equipment types
                const categoryToType = {
                    'hvac': 'hvac',
                    'electrical': 'electrical',
                    'plumbing': 'fire',
                    'security': 'security',
                    'equipment': 'conveyor',
                    'other': 'it'
                };
                
                const equipType = categoryToType[category];
                if (equipType) {
                    // Find matching equipment and update status
                    equipment.forEach(eq => {
                        if (eq.type === equipType) {
                            if (ticketStatus === 'open') {
                                eq.status = 'fault';
                                eq.ticketId = ticket.id;
                            } else if (ticketStatus === 'in_progress') {
                                eq.status = 'maintenance';
                                eq.ticketId = ticket.id;
                            }
                        }
                    });
                }
            });
            
            const statusColors = {
                operational: 0x27ae60,
                maintenance: 0xf1c40f,
                fault: 0xe74c3c
            };
            
            equipment.forEach(eq => {
                const geometry = new THREE.SphereGeometry(0.8, 16, 16);
                const material = new THREE.MeshLambertMaterial({ 
                    color: statusColors[eq.status],
                    emissive: statusColors[eq.status],
                    emissiveIntensity: 0.3
                });
                const sphere = new THREE.Mesh(geometry, material);
                sphere.position.set(eq.x, eq.y, eq.z);
                sphere.userData = eq;
                sphere.castShadow = true;
                
                // Add pulsing animation for faults
                if (eq.status === 'fault') {
                    sphere.userData.pulse = true;
                }
                
                scene.add(sphere);
                equipmentObjects.push(sphere);
            });
        }
        
        function addLabel(text, x, y, z) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 256;
            canvas.height = 64;
            
            context.fillStyle = 'rgba(0,0,0,0.7)';
            context.fillRect(0, 0, 256, 64);
            context.fillStyle = 'white';
            context.font = 'bold 24px Arial';
            context.textAlign = 'center';
            context.fillText(text, 128, 40);
            
            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(material);
            sprite.position.set(x, y, z);
            sprite.scale.set(8, 2, 1);
            scene.add(sprite);
        }
        
        function showEquipmentInfo(data) {
            // Store current equipment data for report issue
            currentEquipmentData = data;
            
            const info = document.getElementById('equipment-info');
            const statusClass = data.status === 'operational' ? 'green' : data.status === 'maintenance' ? 'yellow' : 'red';
            
            let ticketInfo = '';
            let ticketButton = '';
            if (data.ticketId) {
                const ticket = allTickets.find(t => t.id === data.ticketId);
                if (ticket) {
                    ticketInfo = `
                        <p class="ticket-link">ğŸ« <strong>${ticket.id}</strong></p>
                        <p class="ticket-title">${ticket.title}</p>
                    `;
                    ticketButton = `<button class="view-ticket-btn" onclick="viewTicket('${ticket.id}')">ğŸ“‹ View Ticket</button>`;
                }
            }
            
            info.innerHTML = `
                <h4>${data.name}</h4>
                <p><strong>Type:</strong> ${data.type.toUpperCase()}</p>
                <p><strong>Status:</strong> <span class="status-badge ${statusClass}">${data.status}</span></p>
                ${ticketInfo}
                ${ticketButton}
                ${data.status === 'operational' ? '<button class="report-btn" onclick="reportIssue(\'' + data.name + '\')">ğŸ”§ Report Issue</button>' : ''}
            `;
            info.classList.remove('hidden');
        }
        
        // View ticket from 3D view
        function viewTicket(ticketId) {
            // Close 3D modal
            cleanup3DScene();
            document.getElementById('floor-plan-modal').remove();
            
            // Switch to tickets tab
            switchTab('tickets');
            
            // Scroll to the ticket and highlight it
            setTimeout(() => {
                const ticketCard = document.querySelector(`.ticket-card .ticket-id:contains('${ticketId}')`);
                // Highlight the ticket in the list
                const ticketCards = document.querySelectorAll('.ticket-card');
                ticketCards.forEach(card => {
                    if (card.querySelector('.ticket-id')?.textContent === ticketId) {
                        card.style.boxShadow = '0 0 10px #d40511';
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => {
                            card.style.boxShadow = '';
                        }, 3000);
                    }
                });
            }, 200);
        }

        // Store pending issue data for after login
        let pendingIssue = null;
        
        function reportIssue(equipmentName) {
            // Save issue data first (before any modals close)
            const issueData = {
                facilityId: current3DFacilityId,
                equipmentData: currentEquipmentData,
                equipmentName: equipmentName
            };
            
            // Check login - if not logged in, save data and show login
            if (!currentUser) {
                pendingIssue = issueData;
                alert('Please sign in to report an issue');
                showLoginModal();
                return;
            }
            
            // Process the issue
            processIssueReport(issueData);
        }
        
        function processIssueReport(issueData) {
            // Close 3D modal if exists
            const modal = document.getElementById('floor-plan-modal');
            if (modal) {
                cleanup3DScene();
                modal.remove();
            }
            
            // Switch to tickets tab
            switchTab('tickets');
            
            // Use setTimeout to ensure tab is fully switched
            setTimeout(() => {
                // Auto-fill facility
                if (issueData.facilityId) {
                    document.getElementById('ticket-facility').value = issueData.facilityId;
                }
                
                // Auto-fill category based on equipment type
                if (issueData.equipmentData) {
                    const typeToCategory = {
                        'hvac': 'hvac',
                        'fire': 'equipment',
                        'conveyor': 'equipment',
                        'security': 'security',
                        'forklift': 'equipment',
                        'lighting': 'electrical'
                    };
                    const category = typeToCategory[issueData.equipmentData.type] || 'equipment';
                    document.getElementById('ticket-category').value = category;
                }
                
                // Auto-fill title
                document.getElementById('ticket-title').value = 'Equipment Issue: ' + issueData.equipmentName;
                
                // Scroll to form
                document.querySelector('.ticket-form-section').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }
        
        function setViewMode(mode) {
            document.querySelectorAll('.bim-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            if (mode === '3d') {
                camera.position.set(30, 25, 30);
            } else if (mode === 'top') {
                camera.position.set(0, 40, 0);
            } else if (mode === 'front') {
                camera.position.set(0, 10, 40);
            }
            camera.lookAt(0, 0, 0);
        }
        
        let animationId;
        function animate() {
            animationId = requestAnimationFrame(animate);
            
            // Pulse animation for fault equipment
            equipmentObjects.forEach(obj => {
                if (obj.userData.pulse) {
                    const scale = 1 + Math.sin(Date.now() * 0.005) * 0.2;
                    obj.scale.set(scale, scale, scale);
                }
            });
            
            controls.update();
            renderer.render(scene, camera);
        }
        
        function cleanup3DScene() {
            if (animationId) cancelAnimationFrame(animationId);
            if (renderer) renderer.dispose();
            equipmentObjects = [];
            scene = null;
            camera = null;
            renderer = null;
            controls = null;
        }

        function showFacilityList() {
            document.getElementById('facility-details').classList.add('hidden');
            document.getElementById('facility-list').classList.remove('hidden');
        }

        // Search functionality
        document.getElementById('search-input').addEventListener('input', () => {
            // First, go back to list view if in details view
            showFacilityList();
            
            if (facilitiesData) {
                renderFacilityList(facilitiesData.features);
            }
        });

        // Filter functionality
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // First, go back to list view if in details view
                showFacilityList();
                
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.type;
                if (facilitiesData) {
                    renderFacilityList(facilitiesData.features);
                    
                    // Update map filter
                    if (currentFilter === 'all') {
                        map.setFilter('points', null);
                        map.setFilter('labels', null);
                    } else {
                        map.setFilter('points', ['==', ['get', 'type'], currentFilter]);
                        map.setFilter('labels', ['==', ['get', 'type'], currentFilter]);
                    }
                }
            });
        });
    </script>
</body>
</html>
